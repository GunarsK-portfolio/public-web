name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

env:
  PYTHON_VERSION: '3.12'
  # Service URLs - single source of truth
  # Use Traefik HTTPS ports (same as production routing)
  # Playwright configured with ignoreHTTPSErrors for self-signed certs
  AUTH_SERVICE_URL: https://localhost:8443/auth/v1
  ADMIN_API_URL: https://localhost:8443/admin-api/v1
  PUBLIC_API_URL: https://localhost/api/v1
  FILES_API_URL: https://localhost:8443/files-api/v1
  MESSAGING_API_URL: https://localhost:8443/messaging-api/v1
  ADMIN_WEB_URL: https://localhost:8443
  PUBLIC_WEB_URL: https://localhost

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout public-web
        uses: actions/checkout@v6
        with:
          path: public-web

      - name: Checkout infrastructure
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/infrastructure
          path: infrastructure
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout e2e-tests
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/e2e-tests
          path: e2e-tests
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout backend services
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/auth-service
          path: auth-service
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout admin-api
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/admin-api
          path: admin-api
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout admin-web
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/admin-web
          path: admin-web
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout files-api
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/files-api
          path: files-api
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout messaging-api
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/messaging-api
          path: messaging-api
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout messaging-service
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/messaging-service
          path: messaging-service
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout public-api
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/public-api
          path: public-api
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout database
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/database
          path: database
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout portfolio-common
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/portfolio-common
          path: portfolio-common
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: e2e-tests/requirements.txt

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Create infrastructure .env
        working-directory: infrastructure
        run: |
          cp .env.example .env
          # Use default HTTPS URLs from .env.example (Traefik routing)

      - name: Generate TLS certificates for Traefik
        working-directory: infrastructure/docker/traefik/certs
        run: |
          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout localhost.key \
            -out localhost.crt \
            -days 1 \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
          chmod 644 localhost.crt localhost.key

      - name: Start infrastructure
        working-directory: infrastructure
        run: |
          docker compose up -d --build
          echo "Waiting for services to start..."

      - name: Wait for services to be healthy
        run: |
          echo "Starting parallel health checks..."
          timeout 120 bash -c 'until docker exec postgres pg_isready -U postgres; do sleep 2; done' & pid1=$!
          timeout 120 bash -c 'until curl -skf ${{ env.AUTH_SERVICE_URL }}/health; do sleep 2; done' & pid2=$!
          timeout 120 bash -c 'until curl -skf ${{ env.ADMIN_API_URL }}/health; do sleep 2; done' & pid3=$!
          timeout 120 bash -c 'until curl -skf ${{ env.PUBLIC_API_URL }}/health; do sleep 2; done' & pid4=$!
          timeout 120 bash -c 'until curl -skf ${{ env.FILES_API_URL }}/health; do sleep 2; done' & pid5=$!
          timeout 120 bash -c 'until curl -skf ${{ env.MESSAGING_API_URL }}/health; do sleep 2; done' & pid6=$!
          timeout 120 bash -c 'until curl -skf ${{ env.ADMIN_WEB_URL }}/; do sleep 2; done' & pid7=$!
          timeout 120 bash -c 'until curl -skf ${{ env.PUBLIC_WEB_URL }}/; do sleep 2; done' & pid8=$!
          wait $pid1 $pid2 $pid3 $pid4 $pid5 $pid6 $pid7 $pid8
          echo "All services are healthy!"

      - name: Create E2E .env
        working-directory: e2e-tests
        run: |
          echo "TEST_PUBLIC_WEB_URL=${{ env.PUBLIC_WEB_URL }}" > .env
          echo "TEST_PUBLIC_API_URL=${{ env.PUBLIC_API_URL }}" >> .env
          echo "TEST_HEADLESS=true" >> .env
          echo "TEST_TIMEOUT=300000" >> .env
          echo "TEST_BROWSER=chromium" >> .env
          echo "TEST_IGNORE_HTTPS_ERRORS=true" >> .env

      - name: Run E2E tests
        working-directory: e2e-tests
        run: |
          python run_public_tests.py --no-confirm
        # continue-on-error allows artifact upload and log collection before failing
        continue-on-error: true
        id: e2e_tests

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-test-results
          path: |
            e2e-tests/test-results/
            e2e-tests/**/*.png
            e2e-tests/**/*.mp4
          retention-days: 7

      - name: Show docker logs on failure
        if: steps.e2e_tests.outcome == 'failure'
        working-directory: infrastructure
        run: |
          echo "=== Container status ==="
          docker compose ps -a
          echo ""
          echo "=== traefik logs ==="
          docker compose logs traefik --tail=100
          echo ""
          echo "=== public-web logs ==="
          docker compose logs public-web --tail=100
          echo ""
          echo "=== public-api logs ==="
          docker compose logs public-api --tail=50
          echo ""
          echo "=== auth-service logs ==="
          docker compose logs auth-service --tail=50

      - name: Stop infrastructure
        if: always()
        working-directory: infrastructure
        run: docker compose down -v

      - name: Check E2E test result
        if: steps.e2e_tests.outcome == 'failure'
        run: exit 1
